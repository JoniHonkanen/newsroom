name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 30m
        script: |
          cd ${{ secrets.PROJECT_PATH || '/opt/newsroom' }}
          
          echo "üì• Pulling latest code..."
          git fetch origin
          
          CHANGED_FILES=$(git diff HEAD origin/main --name-only)
          
          git reset --hard origin/main
          
          echo "üîÑ Building and restarting services..."
          
          if echo "$CHANGED_FILES" | grep -q "docker-compose"; then
            echo "Docker compose changed - full restart"
            docker compose down
            docker compose build
            docker compose up -d
          else
            echo "Building backend services..."
            docker compose build backend graphql agents
            docker compose up -d backend graphql agents
          fi
          
          echo "‚è≥ Waiting for services..."
          sleep 10
          
          if curl -k -f https://localhost/health >/dev/null 2>&1; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Health check failed"
            docker compose logs --tail=50
            exit 1
          fi